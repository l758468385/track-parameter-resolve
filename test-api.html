<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>API 请求测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>网络请求 Base64 解码器测试</h1>
    
    <div class="test-section">
        <h2>测试说明</h2>
        <p>这个页面会发送包含 base64 编码数据的 API 请求，用于测试插件的拦截和解码功能。</p>
        <p><strong>使用方法：</strong></p>
        <ol>
            <li>确保已安装并启用插件</li>
            <li>打开浏览器开发者工具 (F12)</li>
            <li>点击下面的按钮发送测试请求</li>
            <li>在插件弹窗或 DevTools 的 "Base64 Decoder" 面板中查看解码结果</li>
            <li>也可以在控制台中查看解码输出</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>测试请求</h2>
        <button onclick="sendTrackingRequest()">发送统计追踪请求</button>
        <button onclick="sendAnalyticsRequest()">发送分析请求</button>
        <button onclick="sendEventRequest()">发送事件请求</button>
        <button onclick="sendCustomRequest()">发送自定义请求</button>
        <button onclick="clearLog()">清空日志</button>
        
        <div id="status"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(message, isError = false) {
            statusElement.className = `status ${isError ? 'error' : 'success'}`;
            statusElement.textContent = message;
        }

        function clearLog() {
            logElement.textContent = '';
            statusElement.textContent = '';
        }

        // 模拟你的原始请求
        async function sendTrackingRequest() {
            log('发送统计追踪请求...');
            
            const data = {
                "api_version": "v2",
                "session_id": "c2768d73baaa41359482328edd8e5985Yxf8yo5c",
                "visitor_id": "edc8a267-588c-4fb7-8a25-822c067f062a",
                "fingerprint": "3a441428cb9a494a9b1242d4984e3b93",
                "data": "eyJ0cyI6MTc1OTA0OTcxNDc1MywicmVmZXJlciI6Imh0dHBzOi8vbHJrNjY2LmV1Lm9yZy8iLCJ1cmwiOiJodHRwczovL2xyazY2Ni5ldS5vcmcvcHJvZHVjdHMvZGFuZ2Vyb3VzLXJ1YnkiLCJ1c2VyX2FnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzE0MC4wLjAuMCBTYWZhcmkvNTM3LjM2Iiwic2NyZWVuX3dpZHRoIjoyNDg2LCJzY3JlZW5faGVpZ2h0IjoxMzk5LCJjdXN0b21lcl9pZCI6NSwiZXZlbnQiOiJwYWdlX3ZpZXciLCJwYXJhbWV0ZXJzIjp7InVybCI6Imh0dHBzOi8vbHJrNjY2LmV1Lm9yZy9wcm9kdWN0cy9kYW5nZXJvdXMtcnVieSJ9LCJyZXNvdXJjZV9pZCI6NzYyMCwicGF0aF90eXBlIjoicHJvZHVjdCJ9"
            };

            try {
                const response = await fetch('/api/statistics/v2/track?event_name=page_view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify(data)
                });
                
                log(`请求已发送，状态: ${response.status}`);
                showStatus('统计追踪请求已发送，请检查插件是否捕获到 base64 数据');
            } catch (error) {
                log(`请求失败: ${error.message}`);
                showStatus('请求发送成功（网络错误正常，重点是插件拦截）');
            }
        }

        async function sendAnalyticsRequest() {
            log('发送分析请求...');
            
            const analyticsData = {
                "user_id": "12345",
                "event_type": "click",
                "payload": "eyJ1c2VyX2lkIjoxMjM0NSwiYWN0aW9uIjoiY2xpY2siLCJ0YXJnZXQiOiJidXR0b24iLCJ0aW1lc3RhbXAiOjE3NTkwNDk3MTQ3NTMsInBhZ2UiOiIvcHJvZHVjdHMvZGFuZ2Vyb3VzLXJ1YnkifQ=="
            };

            try {
                await fetch('/api/analytics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analyticsData)
                });
                log('分析请求已发送');
                showStatus('分析请求已发送');
            } catch (error) {
                log(`分析请求: ${error.message}`);
                showStatus('分析请求已发送（拦截成功）');
            }
        }

        async function sendEventRequest() {
            log('发送事件请求...');
            
            const eventData = {
                "event_name": "user_interaction",
                "properties": "eyJldmVudF90eXBlIjoidXNlcl9pbnRlcmFjdGlvbiIsInVzZXJfaWQiOjU2NzgsInNlc3Npb25faWQiOiJhYmMxMjMiLCJwYWdlX3VybCI6Imh0dHBzOi8vZXhhbXBsZS5jb20vdGVzdCIsInRpbWVzdGFtcCI6MTc1OTA0OTcxNDc1M30="
            };

            try {
                await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                log('事件请求已发送');
                showStatus('事件请求已发送');
            } catch (error) {
                log(`事件请求: ${error.message}`);
                showStatus('事件请求已发送（拦截成功）');
            }
        }

        async function sendCustomRequest() {
            log('发送自定义请求...');
            
            // 创建一个包含多个 base64 字段的复杂对象
            const customData = {
                "api_key": "test_key_123",
                "user_data": "eyJ1c2VyX2lkIjoxMjMsInVzZXJuYW1lIjoidGVzdF91c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwicm9sZSI6InVzZXIifQ==",
                "config": {
                    "settings": "eyJhcGlfa2V5IjoiYWJjZGVmZ2hpamtsbW5vcCIsImVuZHBvaW50IjoiaHR0cHM6Ly9hcGkuZXhhbXBsZS5jb20iLCJ0aW1lb3V0IjozMDAwLCJyZXRyaWVzIjozfQ==",
                    "metadata": "eyJ2ZXJzaW9uIjoiMS4wIiwiZW52aXJvbm1lbnQiOiJ0ZXN0IiwiZGVidWciOnRydWV9"
                }
            };

            try {
                await fetch('/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customData)
                });
                log('自定义请求已发送');
                showStatus('自定义请求已发送（包含多个嵌套的 base64 字段）');
            } catch (error) {
                log(`自定义请求: ${error.message}`);
                showStatus('自定义请求已发送（拦截成功）');
            }
        }

        // 页面加载时的提示
        window.addEventListener('load', function() {
            log('测试页面已加载');
            log('请确保插件已安装并启用');
            log('点击上方按钮发送测试请求');
            showStatus('准备就绪 - 点击按钮发送测试请求');
        });
    </script>
</body>
</html>